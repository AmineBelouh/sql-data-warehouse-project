/*
================================================================================
Purpose:
    Analyze yearly sales performance over time.

What this query does:
    1. Aggregates total sales by year from the fact_sales table.
    2. Calculates the overall average yearly sales across all years.
	  3. Computes the difference between each year’s sales and the average.
    4. Compares each year’s sales to the global average
       (Above Average / Below Average / = Average).
    5. Retrieves the previous year’s sales using LAG.
    6. Calculates the year-over-year (YoY) percentage change in sales, safely handling division by zero with NULLIF.

Business use cases:
    - Identify strong vs weak sales years
    - Track long-term sales trends
    - Support performance reporting and strategic decisions
================================================================================
*/

SELECT

    order_year,
    yearly_sales,
    AVG(yearly_sales) OVER()::INT AS avg_sales,
	
    yearly_sales - AVG(yearly_sales) OVER()::INT AS diff_yearly_avg,
    CASE
        WHEN yearly_sales - AVG(yearly_sales) OVER() > 0 THEN 'Above Average'
        WHEN yearly_sales - AVG(yearly_sales) OVER() < 0 THEN 'Below Average'
        ELSE '= Average'
    END AS yearly_vs_avg,
    
    yearly_sales,
    LAG(yearly_sales) OVER(ORDER BY order_year) AS last_year_sales,
    CONCAT(
  		100 * (yearly_sales - LAG(yearly_sales) OVER(ORDER BY order_year)) / NULLIF(LAG(yearly_sales) OVER(ORDER BY order_year), 0)
  		, '%'
		  ) AS pourcentage_change
		
FROM (
    SELECT
        DATE_TRUNC('year', order_date)::DATE AS order_year,
        SUM(sales_amount) AS yearly_sales
    FROM 
        gold.fact_sales
    WHERE 
        order_date IS NOT NULL
    GROUP BY 
        DATE_TRUNC('year', order_date)::DATE
) t



/*
================================================================================
Purpose:
    Analyze yearly sales performance at the product level.

What this query does:
    1. Aggregates total sales per product per year.
    2. Calculates each product’s average yearly sales using a window function.
    3. Computes the difference between a given year’s sales and the product’s
       historical average.
    4. Classifies yearly performance as:
           - Above Its Average
           - Below Its Average
           - = Average
    5. Retrieves the previous year’s sales per product using LAG.
    6. Calculates the year-over-year (YoY) percentage change in sales,
       safely handling division by zero with NULLIF.

Business use cases:
    - Identify products outperforming or underperforming their historical trend
    - Track product growth or decline over time
    - Support product portfolio and pricing decisions
================================================================================
*/

SELECT

    *,
    AVG(product_sales_each_year) OVER(PARTITION BY product_name)::INT AS product_avg_sales,
	
    product_sales_each_year - AVG(product_sales_each_year) OVER(PARTITION BY product_name)::INT AS diff_yearly_avg,
    CASE
        WHEN product_sales_each_year - AVG(product_sales_each_year) OVER(PARTITION BY product_name) > 0 THEN 'Above Its Average'
        WHEN product_sales_each_year - AVG(product_sales_each_year) OVER(PARTITION BY product_name) < 0 THEN 'Below Its Average'
        ELSE '= Average'
    END AS prod_yearly_vs_avg,
	
    product_sales_each_year,
    LAG(product_sales_each_year) OVER(PARTITION BY product_name ORDER BY order_year) AS product_previous_year_sales,
    CONCAT(
  		100*(product_sales_each_year - LAG(product_sales_each_year) OVER(PARTITION BY product_name ORDER BY order_year)) / NULLIF(LAG(product_sales_each_year) OVER(PARTITION BY product_name ORDER BY order_year), 0)
  		, '%') 
		  AS pourcentage_change
  
FROM (
    SELECT
        DATE_TRUNC('year', s.order_date)::DATE AS order_year,	
        p.product_name,
        SUM(s.sales_amount) AS product_sales_each_year
    FROM gold.fact_sales s
    LEFT JOIN gold.dim_products p ON s.product_key = p.product_key
    WHERE order_date IS NOT NULL
    GROUP BY DATE_TRUNC('year', s.order_date)::DATE, p.product_name
) t
